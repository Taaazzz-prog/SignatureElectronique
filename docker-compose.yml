version: '3.8'

services:
  # ğŸ³ APPLICATION SIGNATURE Ã‰LECTRONIQUE - CONNECTÃ‰E AU TRAEFIK FAILDAILY
  signature-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: signature_electronique_app
    restart: unless-stopped
    volumes:
      - signature_uploads:/app/uploads
      - signature_signed:/app/signed
      - signature_signatures:/app/signatures
      - signature_database:/app/data
    environment:
      - DATABASE_PATH=/app/data/signature_app.db
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-please-change-in-production}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY:-}
      - FLASK_ENV=production
    networks:
      - faildaily-ssl-network  # Utilise le rÃ©seau Traefik de FailDaily
    labels:
      # ğŸŒ Configuration Traefik pour Signature Ã‰lectronique
      - "traefik.enable=true"
      - "traefik.http.routers.signature.rule=Host(`signatureelectronique.taaazzz-prog.fr`)"
      - "traefik.http.routers.signature.priority=90"
      - "traefik.http.routers.signature.tls=true"
      - "traefik.http.routers.signature.tls.certresolver=letsencrypt"
      - "traefik.http.services.signature.loadbalancer.server.port=5000"
      # ğŸ”’ Headers de sÃ©curitÃ©
      - "traefik.http.middlewares.signature-security.headers.framedeny=true"
      - "traefik.http.middlewares.signature-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.signature-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.signature-security.headers.referrerPolicy=same-origin"
      - "traefik.http.middlewares.signature-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.signature-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.signature-security.headers.customRequestHeaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.signature.middlewares=signature-security"
      # ğŸ“¦ Limite de taille des fichiers
      - "traefik.http.middlewares.signature-limit.buffering.maxRequestBodyBytes=20971520"  # 20MB

# ğŸ“¦ VOLUMES PERSISTANTS
volumes:
  signature_uploads:
    driver: local
  signature_signed:
    driver: local
  signature_signatures:
    driver: local
  signature_database:
    driver: local

# ğŸŒ RÃ‰SEAUX
networks:
  faildaily-ssl-network:
    external: true  # Utilise le rÃ©seau existant de FailDaily
    name: faildaily_faildaily-ssl-network

# ğŸ¯ CONFIGURATION:
# - Connexion au Traefik centralisÃ© de FailDaily (faildaily-traefik-ssl)
# - SSL automatique via Let's Encrypt
# - Domaine: signatureelectronique.taaazzz-prog.fr
# - Port interne: 5000
# - Serveur: Gunicorn (production-ready)
